<!DOCTYPE html>
<html>
<head>
<title>Highlighted Code</title>
</head>
<body>
<div><h2>Gu√≠a de Colores</h2><ul><li><span style="color: red;">Error</span></li><li><span style="color: blue;">Numbers</span></li><li><span style="color: orange;">Operators</span></li><li><span style="color: navy;">Variables</span></li><li><span style="color: olive;">Functions</span></li><li><span style="color: purple;">Reserved</span></li><li><span style="color: green;">String</span></li><li><span style="color: silver;">Comments</span></li><li><span style="color: brown;">Keys_brackets_punctuation</span></li><li><span style="color: black;">Format</span></li></ul></div><hr><pre>
<span style="color: green;">""</span><span style="color: green;">"
EA-compatible analogue to np.putmask
"</span><span style="color: green;">""</span><br><br><span style="color: purple;">from</span>&nbsp;<span style="color: navy;">__future__</span>&nbsp;<span style="color: purple;">import</span>&nbsp;<span style="color: navy;">annotations</span><br><br><span style="color: purple;">from</span>&nbsp;<span style="color: navy;">typing</span>&nbsp;<span style="color: purple;">import</span>&nbsp;<span style="color: brown;">(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">TYPE_CHECKING</span><span style="color: brown;">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">Any</span><span style="color: brown;">,</span><br><span style="color: brown;">)</span><br><br><span style="color: purple;">import</span>&nbsp;<span style="color: navy;">numpy</span>&nbsp;<span style="color: purple;">as</span>&nbsp;<span style="color: navy;">np</span><br><br><span style="color: purple;">from</span>&nbsp;<span style="color: navy;">pandas</span><span style="color: brown;">.</span><span style="color: navy;">_libs</span>&nbsp;<span style="color: purple;">import</span>&nbsp;<span style="color: navy;">lib</span><br><br><span style="color: purple;">from</span>&nbsp;<span style="color: navy;">pandas</span><span style="color: brown;">.</span><span style="color: navy;">core</span><span style="color: brown;">.</span><span style="color: navy;">dtypes</span><span style="color: brown;">.</span><span style="color: navy;">cast</span>&nbsp;<span style="color: purple;">import</span>&nbsp;<span style="color: navy;">infer_dtype_from</span><br><span style="color: purple;">from</span>&nbsp;<span style="color: navy;">pandas</span><span style="color: brown;">.</span><span style="color: navy;">core</span><span style="color: brown;">.</span><span style="color: navy;">dtypes</span><span style="color: brown;">.</span><span style="color: navy;">common</span>&nbsp;<span style="color: purple;">import</span>&nbsp;<span style="color: navy;">is_list_like</span><br><br><span style="color: purple;">from</span>&nbsp;<span style="color: navy;">pandas</span><span style="color: brown;">.</span><span style="color: navy;">core</span><span style="color: brown;">.</span><span style="color: navy;">arrays</span>&nbsp;<span style="color: purple;">import</span>&nbsp;<span style="color: navy;">ExtensionArray</span><br><br><span style="color: purple;">if</span>&nbsp;<span style="color: navy;">TYPE_CHECKING</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">from</span>&nbsp;<span style="color: navy;">pandas</span><span style="color: brown;">.</span><span style="color: navy;">_typing</span>&nbsp;<span style="color: purple;">import</span>&nbsp;<span style="color: brown;">(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">ArrayLike</span><span style="color: brown;">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">npt</span><span style="color: brown;">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: brown;">)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">from</span>&nbsp;<span style="color: navy;">pandas</span>&nbsp;<span style="color: purple;">import</span>&nbsp;<span style="color: navy;">MultiIndex</span><br><br><br><span style="color: purple;">def</span>&nbsp;<span style="color: olive;">putmask_inplace</span><span style="color: brown;">(</span><span style="color: navy;">values</span><span style="color: brown;">:</span>&nbsp;<span style="color: navy;">ArrayLike</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">mask</span><span style="color: brown;">:</span>&nbsp;<span style="color: navy;">npt</span><span style="color: brown;">.</span><span style="color: olive;">NDArray</span><span style="color: brown;">[</span><span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: navy;">bool_</span><span style="color: brown;">]</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">value</span><span style="color: brown;">:</span>&nbsp;<span style="color: navy;">Any</span><span style="color: brown;">)</span>&nbsp;<span style="color: orange;">-</span><span style="color: orange;">></span>&nbsp;<span style="color: purple;">None</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">""</span><span style="color: green;">"
    ExtensionArray-compatible implementation of np.putmask.  The main
    difference is we do not handle repeating or truncating like numpy.

    Parameters
    ----------
    values: np.ndarray or ExtensionArray
    mask : np.ndarray[bool]
        We assume extract_bool_array has already been called.
    value : Any
    "</span><span style="color: green;">""</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">if</span>&nbsp;<span style="color: brown;">(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">not</span>&nbsp;<span style="color: olive;">isinstance</span><span style="color: brown;">(</span><span style="color: navy;">values</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: navy;">ndarray</span><span style="color: brown;">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">or</span>&nbsp;<span style="color: brown;">(</span><span style="color: navy;">values</span><span style="color: brown;">.</span><span style="color: navy;">dtype</span>&nbsp;<span style="color: orange;">=</span><span style="color: orange;">=</span>&nbsp;<span style="color: navy;">object</span>&nbsp;<span style="color: purple;">and</span>&nbsp;<span style="color: purple;">not</span>&nbsp;<span style="color: navy;">lib</span><span style="color: brown;">.</span><span style="color: olive;">is_scalar</span><span style="color: brown;">(</span><span style="color: navy;">value</span><span style="color: brown;">)</span><span style="color: brown;">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># GH#43424: np.putmask raises TypeError if we cannot cast between types with</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># rule = "safe", a stricter guarantee we may not have here</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">or</span>&nbsp;<span style="color: brown;">(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: olive;">isinstance</span><span style="color: brown;">(</span><span style="color: navy;">value</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: navy;">ndarray</span><span style="color: brown;">)</span>&nbsp;<span style="color: purple;">and</span>&nbsp;<span style="color: purple;">not</span>&nbsp;<span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: olive;">can_cast</span><span style="color: brown;">(</span><span style="color: navy;">value</span><span style="color: brown;">.</span><span style="color: navy;">dtype</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">values</span><span style="color: brown;">.</span><span style="color: navy;">dtype</span><span style="color: brown;">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: brown;">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: brown;">)</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># GH#19266 using np.putmask gives unexpected results with listlike value</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;">#  along with object dtype</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">if</span>&nbsp;<span style="color: olive;">is_list_like</span><span style="color: brown;">(</span><span style="color: navy;">value</span><span style="color: brown;">)</span>&nbsp;<span style="color: purple;">and</span>&nbsp;<span style="color: olive;">len</span><span style="color: brown;">(</span><span style="color: navy;">value</span><span style="color: brown;">)</span>&nbsp;<span style="color: orange;">=</span><span style="color: orange;">=</span>&nbsp;<span style="color: olive;">len</span><span style="color: brown;">(</span><span style="color: navy;">values</span><span style="color: brown;">)</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: olive;">values</span><span style="color: brown;">[</span><span style="color: navy;">mask</span><span style="color: brown;">]</span>&nbsp;<span style="color: orange;">=</span>&nbsp;<span style="color: olive;">value</span><span style="color: brown;">[</span><span style="color: navy;">mask</span><span style="color: brown;">]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">else</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: olive;">values</span><span style="color: brown;">[</span><span style="color: navy;">mask</span><span style="color: brown;">]</span>&nbsp;<span style="color: orange;">=</span>&nbsp;<span style="color: navy;">value</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">else</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># GH#37833 np.putmask is more performant than __setitem__</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: olive;">putmask</span><span style="color: brown;">(</span><span style="color: navy;">values</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">mask</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">value</span><span style="color: brown;">)</span><br><br><br><span style="color: purple;">def</span>&nbsp;<span style="color: olive;">putmask_without_repeat</span><span style="color: brown;">(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">values</span><span style="color: brown;">:</span>&nbsp;<span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: navy;">ndarray</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">mask</span><span style="color: brown;">:</span>&nbsp;<span style="color: navy;">npt</span><span style="color: brown;">.</span><span style="color: olive;">NDArray</span><span style="color: brown;">[</span><span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: navy;">bool_</span><span style="color: brown;">]</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">new</span><span style="color: brown;">:</span>&nbsp;<span style="color: navy;">Any</span><br><span style="color: brown;">)</span>&nbsp;<span style="color: orange;">-</span><span style="color: orange;">></span>&nbsp;<span style="color: purple;">None</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">""</span><span style="color: green;">"
    np.putmask will truncate or repeat if `new` is a listlike with
    len(new) != len(values).  We require an exact match.

    Parameters
    ----------
    values : np.ndarray
    mask : np.ndarray[bool]
    new : Any
    "</span><span style="color: green;">""</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">if</span>&nbsp;<span style="color: olive;">getattr</span><span style="color: brown;">(</span><span style="color: navy;">new</span><span style="color: brown;">,</span>&nbsp;<span style="color: green;">"ndim"</span><span style="color: brown;">,</span>&nbsp;<span style="color: blue;">0</span><span style="color: brown;">)</span>&nbsp;<span style="color: orange;">></span><span style="color: orange;">=</span>&nbsp;<span style="color: blue;">1</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">new</span>&nbsp;<span style="color: orange;">=</span>&nbsp;<span style="color: navy;">new</span><span style="color: brown;">.</span><span style="color: olive;">astype</span><span style="color: brown;">(</span><span style="color: navy;">values</span><span style="color: brown;">.</span><span style="color: navy;">dtype</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">copy</span><span style="color: orange;">=</span><span style="color: purple;">False</span><span style="color: brown;">)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># TODO: this prob needs some better checking for 2D cases</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">nlocs</span>&nbsp;<span style="color: orange;">=</span>&nbsp;<span style="color: navy;">mask</span><span style="color: brown;">.</span><span style="color: olive;">sum</span><span style="color: brown;">(</span><span style="color: brown;">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">if</span>&nbsp;<span style="color: navy;">nlocs</span>&nbsp;<span style="color: orange;">></span>&nbsp;<span style="color: blue;">0</span>&nbsp;<span style="color: purple;">and</span>&nbsp;<span style="color: olive;">is_list_like</span><span style="color: brown;">(</span><span style="color: navy;">new</span><span style="color: brown;">)</span>&nbsp;<span style="color: purple;">and</span>&nbsp;<span style="color: olive;">getattr</span><span style="color: brown;">(</span><span style="color: navy;">new</span><span style="color: brown;">,</span>&nbsp;<span style="color: green;">"ndim"</span><span style="color: brown;">,</span>&nbsp;<span style="color: blue;">1</span><span style="color: brown;">)</span>&nbsp;<span style="color: orange;">=</span><span style="color: orange;">=</span>&nbsp;<span style="color: blue;">1</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">shape</span>&nbsp;<span style="color: orange;">=</span>&nbsp;<span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: olive;">shape</span><span style="color: brown;">(</span><span style="color: navy;">new</span><span style="color: brown;">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># np.shape compat for if setitem_datetimelike_compat</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;">#  changed arraylike to list e.g. test_where_dt64_2d</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">if</span>&nbsp;<span style="color: navy;">nlocs</span>&nbsp;<span style="color: orange;">=</span><span style="color: orange;">=</span>&nbsp;<span style="color: olive;">shape</span><span style="color: brown;">[</span><span style="color: orange;">-</span><span style="color: blue;">1</span><span style="color: brown;">]</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># GH#30567</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># If length of ``new`` is less than the length of ``values``,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># `np.putmask` would first repeat the ``new`` array and then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># assign the masked values hence produces incorrect result.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># `np.place` on the other hand uses the ``new`` values at it is</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># to place in the masked locations of ``values``</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: olive;">place</span><span style="color: brown;">(</span><span style="color: navy;">values</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">mask</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">new</span><span style="color: brown;">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: silver;"># i.e. values[mask] = new</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">elif</span>&nbsp;<span style="color: navy;">mask</span><span style="color: brown;">.</span><span style="color: olive;">shape</span><span style="color: brown;">[</span><span style="color: orange;">-</span><span style="color: blue;">1</span><span style="color: brown;">]</span>&nbsp;<span style="color: orange;">=</span><span style="color: orange;">=</span>&nbsp;<span style="color: olive;">shape</span><span style="color: brown;">[</span><span style="color: orange;">-</span><span style="color: blue;">1</span><span style="color: brown;">]</span>&nbsp;<span style="color: purple;">or</span>&nbsp;<span style="color: olive;">shape</span><span style="color: brown;">[</span><span style="color: orange;">-</span><span style="color: blue;">1</span><span style="color: brown;">]</span>&nbsp;<span style="color: orange;">=</span><span style="color: orange;">=</span>&nbsp;<span style="color: blue;">1</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: olive;">putmask</span><span style="color: brown;">(</span><span style="color: navy;">values</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">mask</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">new</span><span style="color: brown;">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">else</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">raise</span>&nbsp;<span style="color: purple;">ValueError</span><span style="color: brown;">(</span><span style="color: green;">"cannot assign mismatch length to masked array"</span><span style="color: brown;">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: purple;">else</span><span style="color: brown;">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">np</span><span style="color: brown;">.</span><span style="color: olive;">putmask</span><span style="color: brown;">(</span><span style="color: navy;">values</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">mask</span><span style="color: brown;">,</span>&nbsp;<span style="color: navy;">new</span><span style="color: brown;">)</span><br><br><br><span style="color: purple;">def</span>&nbsp;<span style="color: olive;">validate_putmask</span><span style="color: brown;">(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: navy;">values</span><span style="color: brown;">:</span>&nbsp;<span style="color: navy;">ArrayLike</span>&nbsp;
</pre></body>
</html>